<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.safeguard.mapper.ComplaintGisMapper">

    <!-- 공통 조건 SQL (WHERE 태그 없이 조건만 포함) -->
    <sql id="CommonConditions">
        <!-- bounds: Kakao 기준 sw/ne -->
        <if test="req.swLng != null and req.swLat != null and req.neLng != null and req.neLat != null">
            AND ST_Intersects(
            sf.geom,
            ST_MakeEnvelope(#{req.swLng}, #{req.swLat}, #{req.neLng}, #{req.neLat}, 4326)
            )
        </if>

        <!-- category -->
        <if test="req.category != null and req.category != ''">
            AND c.category = #{req.category}
        </if>

        <!-- status -->
        <if test="req.status != null and req.status != ''">
            AND c.status = #{req.status}
        </if>
        <if test="req.showCompleted != null and req.showCompleted == false">
            AND c.status != 'COMPLETED'
        </if>

        <!-- date range: OffsetDateTime from/to -->
        <if test="req.from != null">
            AND c.created_date <![CDATA[ >= ]]> #{req.from}
        </if>
        <if test="req.to != null">
            AND c.created_date <![CDATA[ <= ]]> #{req.to}
        </if>
        <if test="req.agencyNo != null">
            AND ca.agency_no = #{req.agencyNo}
        </if>
        <!-- [추가] 삭제된 민원 제외 -->
        AND c.status != 'DELETED'
    </sql>

    <!-- markers -->
    <select id="selectMapMarkers" resultType="com.safeguard.dto.MapItemDto">
        SELECT DISTINCT
            'MARKER'      AS type,
            ST_Y(sf.geom) AS lat,
            ST_X(sf.geom) AS lng,
            c.complaint_no AS complaintNo,
            c.title        AS title,
            c.category     AS category,
            c.status       AS status,
            sf.addr_text   AS address
        FROM complaint c
        JOIN spatial_feature sf ON sf.complaint_no = c.complaint_no
        LEFT JOIN complaint_agency ca ON c.complaint_no = ca.complaint_no
        <where>
            <include refid="CommonConditions"/>
        </where>
        ORDER BY complaintNo DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>


    <!-- clusters -->
    <select id="selectMapClusters" resultType="com.safeguard.dto.MapClusterDto">
        WITH filtered AS (
            SELECT DISTINCT sf.geom, c.complaint_no
            FROM complaint c
            JOIN spatial_feature sf ON sf.complaint_no = c.complaint_no
            LEFT JOIN complaint_agency ca ON c.complaint_no = ca.complaint_no
            <where>
                <include refid="CommonConditions"/>
            </where>
        )
        SELECT
        COUNT(*) AS count,
        ST_Y(ST_Centroid(ST_Collect(geom))) AS lat,
        ST_X(ST_Centroid(ST_Collect(geom))) AS lng
        FROM (
        SELECT ST_SnapToGrid(geom, #{gridDeg}) AS geom
        FROM filtered
        ) g
        GROUP BY geom
        ORDER BY count DESC
        LIMIT #{limit}
    </select>

    <!-- list -->
    <select id="selectComplaintMapList" resultType="com.safeguard.dto.ComplaintListItemDto">
        SELECT DISTINCT
            c.complaint_no AS complaintNo,
            c.title        AS title,
            c.category     AS category,
            c.status       AS status,
            c.created_date AS createdDate,
            sf.addr_text   AS addrText
        FROM complaint c
        JOIN spatial_feature sf ON sf.complaint_no = c.complaint_no
        LEFT JOIN complaint_agency ca ON c.complaint_no = ca.complaint_no
        <where>
            <include refid="CommonConditions"/>
        </where>
        ORDER BY createdDate DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <!-- hotspots (ST_HexagonGrid) -->
    <resultMap id="HotspotResultMap" type="com.safeguard.dto.MapHotspotDto" >
        <id property="cellId" column="cell_id"/>
        <result property="count" column="count"/>
        <collection property="points" ofType="com.safeguard.dto.MapHotspotDto$PointDto">
            <result property="lat" column="lat"/>
            <result property="lng" column="lng"/>
        </collection>
    </resultMap>

    <select id="selectHotspots" resultMap="HotspotResultMap">
        WITH grid AS (
            SELECT ST_HexagonGrid(#{gridDeg}, ST_SetSRID(ST_MakeEnvelope(
                #{req.swLng}, #{req.swLat}, #{req.neLng}, #{req.neLat}
            ), 4326)) AS cell
        ),
        hexagons AS (
            SELECT (grid.cell).geom AS geom, (grid.cell).i, (grid.cell).j
            FROM grid
        ),
        counts AS (
            SELECT h.geom, h.i, h.j, COUNT(DISTINCT c.complaint_no) AS cnt
            FROM hexagons h
            JOIN spatial_feature sf ON ST_Intersects(h.geom, sf.geom)
            JOIN complaint c ON c.complaint_no = sf.complaint_no
            LEFT JOIN complaint_agency ca ON c.complaint_no = ca.complaint_no
            <where>
                <include refid="CommonConditions"/>
                AND c.status != 'COMPLETED'
            </where>
            GROUP BY h.geom, h.i, h.j
            HAVING COUNT(DISTINCT c.complaint_no) > 0
        ),
        points AS (
            SELECT cnt, i, j, (ST_DumpPoints(geom)).geom AS pt
            FROM counts
        )
        SELECT
            i || '_' || j AS cell_id,
            cnt           AS "count",
            ST_Y(pt)      AS "lat",
            ST_X(pt)      AS "lng"
        FROM points
        ORDER BY cell_id
    </select>

    <!-- District Counts (Sigungu Aggregation) -->
    <select id="selectDistrictCounts" resultType="com.safeguard.dto.MapDistrictDto">
        SELECT
            CASE
                WHEN sf.addr_text LIKE '서울특별시 %' THEN
                    TRIM(SPLIT_PART(sf.addr_text, ' ', 1) || ' ' || SPLIT_PART(sf.addr_text, ' ', 2))
                WHEN sf.addr_text = '서울특별시' THEN '서울특별시'
                WHEN sf.addr_text LIKE '%광역시 %' OR sf.addr_text LIKE '세종특별자치시 %' THEN
                    SPLIT_PART(sf.addr_text, ' ', 1)
                WHEN sf.addr_text LIKE '%광역시' OR sf.addr_text = '세종특별자치시' THEN sf.addr_text
                ELSE
                    TRIM(SPLIT_PART(sf.addr_text, ' ', 1) || ' ' || SPLIT_PART(sf.addr_text, ' ', 2))
            END AS name,
            COUNT(DISTINCT c.complaint_no) AS count
        FROM complaint c
        JOIN spatial_feature sf ON sf.complaint_no = c.complaint_no
        LEFT JOIN complaint_agency ca ON c.complaint_no = ca.complaint_no
        <where>
            <include refid="CommonConditions"/>
        </where>
        GROUP BY name
        HAVING COUNT(DISTINCT c.complaint_no) > 0
        ORDER BY count DESC
    </select>

    <!-- count -->
    <select id="countComplaintMapList" resultType="long">
        SELECT COUNT(DISTINCT c.complaint_no)
        FROM complaint c
        JOIN spatial_feature sf ON sf.complaint_no = c.complaint_no
        LEFT JOIN complaint_agency ca ON c.complaint_no = ca.complaint_no
        <where>
            <include refid="CommonConditions"/>
        </where>
    </select>

</mapper>
