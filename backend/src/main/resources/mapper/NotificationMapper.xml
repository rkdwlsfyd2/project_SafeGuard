<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.safeguard.mapper.NotificationMapper">

    <insert id="insertNotification" parameterType="com.safeguard.dto.NotificationDTO" useGeneratedKeys="true" keyProperty="notificationId" keyColumn="notification_id">
        INSERT INTO notification (user_no, complaint_no, type, message, is_read, created_at)
        VALUES (#{userNo}, #{complaintNo}, #{type}, #{message}, false, CURRENT_TIMESTAMP)
    </insert>

    <select id="selectNotificationsByUser" resultType="com.safeguard.dto.NotificationDTO">
        SELECT 
            notification_id AS notificationId,
            user_no AS userNo,
            complaint_no AS complaintNo,
            type,
            message,
            is_read AS isRead,
            created_at AS createdAt
        FROM notification
        WHERE user_no = #{userNo}
          AND created_at >= NOW() - INTERVAL '3 DAYS'
        ORDER BY created_at DESC
        LIMIT 50
    </select>

    <select id="countUnread" resultType="int">
        SELECT COUNT(*)
        FROM notification
        WHERE user_no = #{userNo}
          AND is_read = false
          AND created_at >= NOW() - INTERVAL '3 DAYS'
    </select>

    <update id="markAsRead">
        UPDATE notification
        SET is_read = true, read_at = NOW()
        WHERE notification_id = #{notificationId}
          AND user_no = #{userNo}
          AND is_read = false
    </update>

</mapper>
