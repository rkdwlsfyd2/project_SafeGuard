<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.safeguard.mapper.ComplaintMapper">

    <!-- 민원 목록 조회 (필터/검색/기관 포함) -->
    <select id="selectComplaintList" resultType="com.safeguard.dto.ComplaintDTO">
        SELECT
            c.complaint_no AS complaintNo,
            c.title,
            c.content,
            c.category,
            c.status,
            c.created_date AS createdDate,
            c.address,
            c.latitude,
            c.longitude,
            c.image_path AS imagePath,
            c.answer,
            c.is_public AS isPublic,
            c.like_count AS likeCount,
            ca.agency_no AS agencyNo,
            a.agency_name AS agencyName,
            (
                SELECT a_reg.region_code
                FROM complaint_agency ca_reg
                JOIN agency a_reg ON ca_reg.agency_no = a_reg.agency_no
                WHERE ca_reg.complaint_no = c.complaint_no AND a_reg.agency_type = 'LOCAL'
                ORDER BY a_reg.agency_no ASC
                LIMIT 1
            ) AS regionCode,
            (
                SELECT a_reg.agency_name
                FROM complaint_agency ca_reg
                JOIN agency a_reg ON ca_reg.agency_no = a_reg.agency_no
                WHERE ca_reg.complaint_no = c.complaint_no AND a_reg.agency_type = 'LOCAL'
                ORDER BY a_reg.agency_no ASC
                LIMIT 1
            ) AS regionName
        FROM complaint c
        LEFT JOIN complaint_agency ca
            ON c.complaint_no = ca.complaint_no
        LEFT JOIN agency a
            ON ca.agency_no = a.agency_no
        <where>
            <if test="category != null and category != '전체'">
                AND c.category = #{category}
            </if>
            <if test="status != null and status != '전체'">
                AND c.status = #{status}
            </if>
            <if test="agencyNo != null">
                AND ca.agency_no = #{agencyNo}
            </if>
            <!-- [수정] 지역 필터: region_code 사용 -->
            <if test="region != null and region != '전체'">
                AND a.region_code = #{region}
            </if>
            <if test="search != null and search != ''">
                AND (c.title ILIKE CONCAT('%', #{search}, '%')
                 OR c.content ILIKE CONCAT('%', #{search}, '%'))
            </if>
        </where>
        ORDER BY c.complaint_no DESC
    </select>

    <!-- 민원 상세 -->
    <select id="findByComplaintNo" resultType="com.safeguard.dto.ComplaintDTO">
        SELECT
            c.complaint_no AS complaintNo,
            c.title,
            c.content,
            c.category,
            c.status,
            c.created_date AS createdDate,
            c.updated_date AS updatedDate,
            c.completed_date AS completedDate,
            c.address,
            c.latitude,
            c.longitude,
            c.image_path AS imagePath,
            c.answer,
            c.is_public AS isPublic,
            (
                SELECT COUNT(*) FROM complaint_like cl 
                WHERE cl.complaint_no = c.complaint_no AND cl.type = 'LIKE'
            ) AS likeCount,
            (
                SELECT COUNT(*) FROM complaint_like cl 
                WHERE cl.complaint_no = c.complaint_no AND cl.type = 'DISLIKE'
            ) AS dislikeCount,
            (
                SELECT cl.type FROM complaint_like cl 
                WHERE cl.complaint_no = c.complaint_no AND cl.user_no = #{userNo}
            ) AS myReaction,
            CASE WHEN c.user_no = #{userNo} THEN TRUE ELSE FALSE END AS isMyPost,
            CASE 
                WHEN EXISTS (
                    SELECT 1 FROM complaint_agency ca_check 
                    WHERE ca_check.complaint_no = c.complaint_no 
                    AND ca_check.agency_no = #{viewerAgencyNo}
                ) THEN TRUE 
                ELSE FALSE 
            END AS isAssignedToMe,
            MAX(ca.agency_no) AS agencyNo, -- Legacy support
            STRING_AGG(CAST(ca.agency_no AS text), ',') AS assignedAgencyIdsStr,
            MAX(a.agency_name) AS agencyName,
            MAX(a.region_code) AS regionCode,
            MAX(CASE 
                WHEN a.agency_type = 'LOCAL' THEN a.agency_name
                ELSE NULL
            END) AS regionName,
            (
                SELECT STRING_AGG(a2.agency_name, ', ')
                FROM agency a2
                JOIN complaint_agency ca2 ON ca2.agency_no = a2.agency_no
                WHERE ca2.complaint_no = c.complaint_no
            ) AS assignedAgencyText,
            MAX(u.name) AS authorName
        FROM complaint c
        LEFT JOIN app_user u ON c.user_no = u.user_no
        LEFT JOIN complaint_agency ca
            ON c.complaint_no = ca.complaint_no
        LEFT JOIN agency a
            ON ca.agency_no = a.agency_no
        WHERE c.complaint_no = #{complaintNo}
        GROUP BY c.complaint_no
    </select>

    <!-- 민원 등록 (Entity) : 서비스(createComplaint)에서 호출 -->
    <insert id="insertComplaint" useGeneratedKeys="true" keyProperty="complaintNo" keyColumn="complaint_no">
        INSERT INTO complaint (
            title, content, category, status, is_public, user_no, image_path, created_date, updated_date,
            address, latitude, longitude
        )
        VALUES (
            #{title}, #{content}, #{category}, #{status}, #{isPublic}, #{userNo}, #{imagePath},
            CURRENT_TIMESTAMP, CURRENT_TIMESTAMP,
            #{address}, #{latitude}, #{longitude}
        )
    </insert>

    <!-- 공간 정보 등록 : 서비스(createComplaint)에서 호출 -->
    <insert id="insertSpatialFeature" useGeneratedKeys="true" keyProperty="featureId"
            parameterType="com.safeguard.entity.SpatialFeature">
        INSERT INTO spatial_feature (
            feature_type, geom, addr_text, complaint_no, created_at
        ) VALUES (
            #{featureType},
            ST_GeomFromText(#{geom, typeHandler=com.safeguard.config.GeometryTypeHandler}, 4326),
            #{addrText},
            #{complaintNo},
            CURRENT_TIMESTAMP
        )
    </insert>

    <!-- 기관 매핑 등록 -->
    <insert id="insertComplaintAgency">
        INSERT INTO complaint_agency (complaint_no, agency_no)
        VALUES (#{complaintNo}, #{agencyNo})
    </insert>

    <!-- 시드용 DTO 등록 (데이터 초기화/테스트용) -->
    <insert id="insertComplaintDto" useGeneratedKeys="true" keyProperty="complaintNo"
            parameterType="com.safeguard.dto.ComplaintDTO">
        INSERT INTO complaint (
            title, content, category, status, is_public, user_no, created_date, updated_date, completed_date,
            address, latitude, longitude, image_path, like_count
        ) VALUES (
            #{title}, #{content}, #{category}, #{status}, #{isPublic}, #{userNo}, #{createdDate}, #{updatedDate}, #{completedDate},
            #{address}, #{latitude}, #{longitude}, #{imagePath}, #{likeCount}
        )
    </insert>

    <!-- Shared Where Clause (대시보드/목록 공용) -->
    <sql id="SharedWhere">
        <where>
            <if test="search != null and search != ''">
                AND (c.title ILIKE CONCAT('%', #{search}, '%')
                 OR c.content ILIKE CONCAT('%', #{search}, '%'))
            </if>
            <if test="category != null and category != '전체'">
                AND c.category = #{category}
            </if>
            <if test="status != null and status != '전체'">
                AND c.status = #{status}
            </if>
            <if test="agencyNo != null">
                AND ca.agency_no = #{agencyNo}
            </if>
            <!-- [수정] 지역 필터: region_code 사용 -->
            <if test="region != null and region != '전체'">
                AND a.region_code = #{region}
            </if>
            <!-- [추가] 삭제된 민원 제외 -->
            AND c.status != 'DELETED'
        </where>
    </sql>

    <!-- 대시보드/목록 페이징 조회 -->
    <!-- 대시보드/목록 페이징 조회 -->
    <select id="findAll" resultType="com.safeguard.dto.ComplaintDTO">
        SELECT
            c.complaint_no AS complaintNo,
            c.title,
            c.category,
            c.status,
            c.created_date AS createdDate,
            c.address,
            c.is_public AS isPublic,
            c.like_count AS likeCount,
            MAX(ca.agency_no) AS agencyNo,
            MAX(a.agency_name) AS agencyName,
            (
                SELECT a_reg.region_code
                FROM complaint_agency ca_reg
                JOIN agency a_reg ON ca_reg.agency_no = a_reg.agency_no
                WHERE ca_reg.complaint_no = c.complaint_no AND a_reg.agency_type = 'LOCAL'
                ORDER BY a_reg.agency_no ASC
                LIMIT 1
            ) AS regionCode,
            (
                SELECT a_reg.agency_name
                FROM complaint_agency ca_reg
                JOIN agency a_reg ON ca_reg.agency_no = a_reg.agency_no
                WHERE ca_reg.complaint_no = c.complaint_no AND a_reg.agency_type = 'LOCAL'
                ORDER BY a_reg.agency_no ASC
                LIMIT 1
            ) AS regionName
        FROM complaint c
        LEFT JOIN complaint_agency ca
            ON c.complaint_no = ca.complaint_no
        LEFT JOIN agency a
            ON ca.agency_no = a.agency_no
        <include refid="SharedWhere"/>
        GROUP BY c.complaint_no
        ORDER BY
        <choose>
            <when test="sort == 'created_date'">c.created_date</when>
            <when test="sort == 'likeCount'">c.like_count DESC, c.complaint_no</when>
            <otherwise>c.complaint_no</otherwise>
        </choose>
        <choose>
            <when test="order == 'ASC'">ASC</when>
            <otherwise>DESC</otherwise>
        </choose>
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <!-- 페이징 total count -->
    <select id="countAll" resultType="long">
        SELECT COUNT(DISTINCT c.complaint_no)
        FROM complaint c
        LEFT JOIN complaint_agency ca
            ON c.complaint_no = ca.complaint_no
        LEFT JOIN agency a
            ON ca.agency_no = a.agency_no
        <include refid="SharedWhere"/>
    </select>


    <!-- 좋아요 여부 -->
    <select id="isLikedByUser" resultType="boolean">
        SELECT EXISTS (
            SELECT 1 FROM complaint_like
            WHERE complaint_no = #{complaintNo} AND user_no = #{userNo}
        )
    </select>

    <update id="updateStatus">
        UPDATE complaint
        SET status = #{status},
            updated_date = CURRENT_TIMESTAMP
        WHERE complaint_no = #{complaintNo}
    </update>

    <update id="updateAnswer">
        UPDATE complaint
        SET answer = #{answer},
            updated_date = CURRENT_TIMESTAMP
        WHERE complaint_no = #{complaintNo}
    </update>

    <select id="checkUserLike" resultType="int">
        SELECT COUNT(*)::int
        FROM complaint_like
        WHERE complaint_no = #{complaintNo} AND user_no = #{userNo}
    </select>

    <!-- 좋아요 등록: 중복 클릭/동시 요청 방지 -->
    <insert id="insertLike">
        INSERT INTO complaint_like (complaint_no, user_no)
        VALUES (#{complaintNo}, #{userNo})
        ON CONFLICT (complaint_no, user_no) DO NOTHING
    </insert>

    <delete id="deleteLike">
        DELETE FROM complaint_like
        WHERE complaint_no = #{complaintNo} AND user_no = #{userNo}
    </delete>

    <update id="updateLikeCount">
        UPDATE complaint
        SET like_count = COALESCE(like_count, 0) + 1
        WHERE complaint_no = #{complaintNo}
    </update>

    <update id="decreaseLikeCount">
        UPDATE complaint
        SET like_count = GREATEST(COALESCE(like_count, 0) - 1, 0)
        WHERE complaint_no = #{complaintNo}
    </update>

    <!-- Reaction Queries -->
    <select id="findReactionByUser" resultType="string">
        SELECT type
        FROM complaint_like
        WHERE complaint_no = #{complaintNo} AND user_no = #{userNo}
    </select>
    
    <insert id="insertReaction">
        INSERT INTO complaint_like (complaint_no, user_no, type)
        VALUES (#{complaintNo}, #{userNo}, #{type})
    </insert>

    <update id="updateReaction">
        UPDATE complaint_like
        SET type = #{type}
        WHERE complaint_no = #{complaintNo} AND user_no = #{userNo}
    </update>

    <delete id="deleteReaction">
        DELETE FROM complaint_like
        WHERE complaint_no = #{complaintNo} AND user_no = #{userNo}
    </delete>
    
    <!-- Update legacy like_count column for list view compatibility (only likes) -->
    <update id="updateComplaintLikeCount">
        UPDATE complaint
        SET like_count = (
            SELECT COUNT(*) FROM complaint_like 
            WHERE complaint_no = #{complaintNo} AND type = 'LIKE'
        )
        WHERE complaint_no = #{complaintNo}
    </update>

    <select id="selectTopLikedComplaints" resultType="com.safeguard.dto.ComplaintDTO">
        SELECT DISTINCT c.*
        FROM complaint c
        LEFT JOIN complaint_agency ca ON c.complaint_no = ca.complaint_no
        <where>
            <if test="status != null and status != 'ALL'">
                AND c.status = #{status}
            </if>
            <if test="agencyNo != null">
                AND ca.agency_no = #{agencyNo}
            </if>
        </where>
        ORDER BY c.like_count DESC, c.complaint_no DESC
        LIMIT 5
    </select>

    <resultMap id="StatsResultMap" type="com.safeguard.dto.ComplaintStatsDTO">
        <result property="total" column="total"/>
        <result property="today" column="today"/>
        <result property="received" column="received"/>
        <result property="processing" column="processing"/>
        <result property="completed" column="completed"/>
        <result property="slaCompliance" column="sla_compliance"/>
        <result property="overdue" column="overdue"/>
        <result property="avgProcessingDays" column="avg_processing_days"/>
        <result property="completionRate" column="completion_rate"/>
        <result property="safetyRiskRate" column="safety_risk_rate"/>
        <result property="longTermUnprocessedRate" column="long_term_unprocessed_rate"/>
        
        <!-- Summary Bar용 신규 매핑 -->
        <result property="todayCount" column="todayCount"/>
        <result property="yesterdayCount" column="yesterdayCount"/>
        <result property="monthCount" column="monthCount"/>
        <result property="lastMonthCount" column="lastMonthCount"/>
        <result property="yearCount" column="yearCount"/>
        <result property="lastYearCount" column="lastYearCount"/>
    </resultMap>

    <!-- 통계(요약): 전체 건수, 상태별(UNPROCESSED, IN_PROGRESS 등) 카운트 및 SLA 준수율 조회 -->
    <select id="selectComplaintStats" resultMap="StatsResultMap">
        SELECT
            COUNT(DISTINCT c.complaint_no) AS total,
            COUNT(DISTINCT CASE WHEN CAST(c.created_date AS DATE) = CURRENT_DATE THEN c.complaint_no END) AS today,
            COUNT(DISTINCT CASE WHEN c.status = 'UNPROCESSED' THEN c.complaint_no END) AS received,
            COUNT(DISTINCT CASE WHEN c.status = 'IN_PROGRESS' THEN c.complaint_no END) AS processing,
            COUNT(DISTINCT CASE WHEN c.status = 'COMPLETED' THEN c.complaint_no END) AS completed,
            COALESCE(ROUND(
                (COUNT(DISTINCT CASE 
                    WHEN c.status = 'COMPLETED' AND (
                        SELECT count(*) 
                        FROM generate_series(c.created_date::date + 1, c.updated_date::date, '1 day') AS d 
                        WHERE extract(dow from d) NOT IN (0, 6)
                    ) &lt;= 3 THEN c.complaint_no 
                END)::numeric /
                NULLIF(COUNT(DISTINCT CASE WHEN c.status = 'COMPLETED' THEN c.complaint_no END), 0)) * 100, 1
            ), 0) AS sla_compliance,
            COUNT(DISTINCT CASE 
                WHEN c.status IN ('RECEIVED', 'UNPROCESSED', 'IN_PROGRESS') AND (
                    SELECT count(*) 
                    FROM generate_series(c.created_date::date + 1, CURRENT_DATE, '1 day') AS d 
                    WHERE extract(dow from d) NOT IN (0, 6)
                ) > 3 THEN c.complaint_no 
            END) AS overdue,
            
            <!-- Summary Bar용 기간별 집계: 오늘/어제/이번달/지난달/올해/작년 데이터를 한 번에 조회 -->
            <!-- CASE WHEN 구문을 활용하여 조건부 카운팅 수행 (DB 접근 최소화) -->
            COUNT(DISTINCT CASE WHEN CAST(c.created_date AS DATE) = CURRENT_DATE THEN c.complaint_no END) AS todayCount,
            COUNT(DISTINCT CASE WHEN CAST(c.created_date AS DATE) = CURRENT_DATE - INTERVAL '1 day' THEN c.complaint_no END) AS yesterdayCount,
            COUNT(DISTINCT CASE WHEN TO_CHAR(c.created_date, 'YYYY-MM') = TO_CHAR(NOW(), 'YYYY-MM') THEN c.complaint_no END) AS monthCount,
            COUNT(DISTINCT CASE WHEN TO_CHAR(c.created_date, 'YYYY-MM') = TO_CHAR(NOW() - INTERVAL '1 month', 'YYYY-MM') THEN c.complaint_no END) AS lastMonthCount,
            COUNT(DISTINCT CASE WHEN TO_CHAR(c.created_date, 'YYYY') = TO_CHAR(NOW(), 'YYYY') THEN c.complaint_no END) AS yearCount,
            COUNT(DISTINCT CASE WHEN TO_CHAR(c.created_date, 'YYYY') = TO_CHAR(NOW() - INTERVAL '1 year', 'YYYY') THEN c.complaint_no END) AS lastYearCount,

            COALESCE(ROUND(
                AVG(EXTRACT(EPOCH FROM (c.completed_date - c.created_date)) / 86400.0) FILTER (WHERE c.status = 'COMPLETED'), 1
            ), 0) AS avg_processing_days,
            COALESCE(ROUND(
                (COUNT(DISTINCT CASE WHEN c.status = 'COMPLETED' AND TO_CHAR(c.completed_date, 'YYYY-MM') = TO_CHAR(NOW(), 'YYYY-MM') THEN c.complaint_no END)::numeric /
                NULLIF(COUNT(DISTINCT CASE WHEN TO_CHAR(c.created_date, 'YYYY-MM') = TO_CHAR(NOW(), 'YYYY-MM') THEN c.complaint_no END), 0)) * 100, 1
            ), 0) AS completion_rate,
            COALESCE(ROUND(
                (COUNT(DISTINCT CASE WHEN c.status IN ('RECEIVED', 'UNPROCESSED', 'IN_PROGRESS') AND (
                    SELECT count(*) 
                    FROM generate_series(c.created_date::date + 1, CURRENT_DATE, '1 day') AS d 
                    WHERE extract(dow from d) NOT IN (0, 6)
                ) > 14 THEN c.complaint_no END)::numeric /
                NULLIF(COUNT(DISTINCT CASE WHEN c.status IN ('RECEIVED', 'UNPROCESSED', 'IN_PROGRESS') THEN c.complaint_no END), 0)) * 100, 1
            ), 0) AS long_term_unprocessed_rate
        FROM complaint c
        LEFT JOIN complaint_agency ca
            ON c.complaint_no = ca.complaint_no
        <where>
            <if test="agencyNo != null">
                AND ca.agency_no = #{agencyNo}
            </if>
            <if test="category != null and category != '전체'">
                AND c.category = #{category}
            </if>
            AND c.status != 'DELETED'
        </where>
    </select>

    <!-- 통계(분포): status별 count (기존 중복 id였던 부분은 id 변경) -->
    <select id="selectComplaintStatusCounts" resultType="map">
        SELECT c.status, COUNT(*) as count
        FROM complaint c
        LEFT JOIN complaint_agency ca
            ON c.complaint_no = ca.complaint_no
        <where>
            <if test="agencyNo != null">
                AND ca.agency_no = #{agencyNo}
            </if>
        </where>
        GROUP BY c.status
    </select>

    <select id="selectComplaintListByUserNo" resultType="com.safeguard.dto.ComplaintDTO">
        SELECT *
        FROM complaint
        WHERE user_no = #{userNo}
        ORDER BY created_date DESC
    </select>

    <!-- 전체 좋아요 삭제 (초기화용) -->
    <delete id="deleteAllLikes">
        DELETE FROM complaint_like
    </delete>

    <!-- 전체 민원 삭제 (초기화용) -->
    <delete id="deleteAllComplaints">
        DELETE FROM complaint
    </delete>

    <delete id="deleteByUserNo">
        DELETE FROM complaint
        WHERE user_no = #{userNo}
    </delete>

    <!-- 통계(카테고리별): 민원 카테고리별 건수 분포 및 전일 대비 증감률 조회 -->
    <select id="selectCategoryStats" resultType="map">
        SELECT 
            category AS name, 
            COUNT(DISTINCT c.complaint_no)::int AS value,
            COALESCE(ROUND(
                (
                    (COUNT(DISTINCT CASE WHEN CAST(c.created_date AS DATE) = CURRENT_DATE THEN c.complaint_no END) - 
                     COUNT(DISTINCT CASE WHEN CAST(c.created_date AS DATE) = CURRENT_DATE - INTERVAL '1 day' THEN c.complaint_no END))::numeric
                    / 
                    NULLIF(COUNT(DISTINCT CASE WHEN CAST(c.created_date AS DATE) = CURRENT_DATE - INTERVAL '1 day' THEN c.complaint_no END), 0)
                ) * 100, 1
            ), 0) AS change
        FROM complaint c
        LEFT JOIN complaint_agency ca ON c.complaint_no = ca.complaint_no
        <where>
            <if test="agencyNo != null">
                AND ca.agency_no = #{agencyNo}
            </if>
            AND c.status != 'DELETED'
        </where>
        GROUP BY category
        ORDER BY value DESC
    </select>

    <!-- 통계(트렌드): 기간 단위(연/월/일)별 접수, 완료 건수 및 SLA 준수율 추이 조회 -->
    <select id="selectMonthlyTrend" resultType="map">
        <choose>
            <when test="timeBasis == 'YEAR'">
                SELECT 
                    TO_CHAR(d, 'YYYY') AS month,
                    (
                        SELECT COUNT(*)::int 
                        FROM complaint c 
                        LEFT JOIN complaint_agency ca ON c.complaint_no = ca.complaint_no
                        WHERE TO_CHAR(c.created_date, 'YYYY') = TO_CHAR(d, 'YYYY')
                        AND c.status != 'DELETED'
                        <if test="category != null and category != '전체' and category != ''">
                            AND c.category = #{category}
                        </if>
                        <if test="agencyNo != null">
                            AND ca.agency_no = #{agencyNo}
                        </if>
                    ) AS received,
                    (
                        SELECT COUNT(*)::int 
                        FROM complaint c 
                        LEFT JOIN complaint_agency ca ON c.complaint_no = ca.complaint_no
                        WHERE TO_CHAR(c.completed_date, 'YYYY') = TO_CHAR(d, 'YYYY')
                        AND c.status != 'DELETED'
                        <if test="category != null and category != '전체' and category != ''">
                            AND c.category = #{category}
                        </if>
                        <if test="agencyNo != null">
                            AND ca.agency_no = #{agencyNo}
                        </if>
                    ) AS completed,
                    COALESCE((
                        SELECT ROUND(
                            AVG(CASE WHEN (
                                SELECT count(*) 
                                FROM generate_series(c.created_date::date + 1, c.updated_date::date, '1 day') AS gs 
                                WHERE extract(dow from gs) NOT IN (0, 6)
                            ) &lt;= 3 THEN 100.0 ELSE 0.0 END), 1
                        )
                        FROM complaint c 
                        LEFT JOIN complaint_agency ca ON c.complaint_no = ca.complaint_no
                        WHERE c.status = 'COMPLETED' 
                        AND TO_CHAR(c.completed_date, 'YYYY') = TO_CHAR(d, 'YYYY')
                        <if test="category != null and category != '전체' and category != ''">
                            AND c.category = #{category}
                        </if>
                        <if test="agencyNo != null">
                            AND ca.agency_no = #{agencyNo}
                        </if>
                    ), 0) AS sla_rate
                FROM (
                    SELECT generate_series(
                        CURRENT_DATE - INTERVAL '4 years', 
                        CURRENT_DATE, 
                        '1 year'
                    )::date AS d
                ) d
                ORDER BY d ASC
            </when>
            <when test="timeBasis == 'DAY'">
                SELECT 
                    TO_CHAR(d, 'MM-DD') AS month,
                    (
                        SELECT COUNT(*)::int 
                        FROM complaint c 
                        LEFT JOIN complaint_agency ca ON c.complaint_no = ca.complaint_no
                        WHERE TO_CHAR(c.created_date, 'MM-DD') = TO_CHAR(d, 'MM-DD')
                        AND c.status != 'DELETED'
                        <if test="category != null and category != '전체' and category != ''">
                            AND c.category = #{category}
                        </if>
                        <if test="agencyNo != null">
                            AND ca.agency_no = #{agencyNo}
                        </if>
                    ) AS received,
                    (
                        SELECT COUNT(*)::int 
                        FROM complaint c 
                        LEFT JOIN complaint_agency ca ON c.complaint_no = ca.complaint_no
                        WHERE TO_CHAR(c.completed_date, 'MM-DD') = TO_CHAR(d, 'MM-DD')
                        AND c.status != 'DELETED'
                        <if test="category != null and category != '전체' and category != ''">
                            AND c.category = #{category}
                        </if>
                        <if test="agencyNo != null">
                            AND ca.agency_no = #{agencyNo}
                        </if>
                    ) AS completed,
                    COALESCE((
                        SELECT ROUND(
                            AVG(CASE WHEN (
                                SELECT count(*) 
                                FROM generate_series(c.created_date::date + 1, c.updated_date::date, '1 day') AS gs 
                                WHERE extract(dow from gs) NOT IN (0, 6)
                            ) &lt;= 3 THEN 100.0 ELSE 0.0 END), 1
                        )
                        FROM complaint c 
                        LEFT JOIN complaint_agency ca ON c.complaint_no = ca.complaint_no
                        WHERE c.status = 'COMPLETED' 
                        AND TO_CHAR(c.completed_date, 'MM-DD') = TO_CHAR(d, 'MM-DD')
                        <if test="category != null and category != '전체' and category != ''">
                            AND c.category = #{category}
                        </if>
                        <if test="agencyNo != null">
                            AND ca.agency_no = #{agencyNo}
                        </if>
                    ), 0) AS sla_rate
                FROM (
                    SELECT generate_series(
                        CURRENT_DATE - INTERVAL '13 days', 
                        CURRENT_DATE, 
                        '1 day'
                    )::date AS d
                ) d
                ORDER BY d ASC
            </when>
            <otherwise>
                <!-- Default: MONTH -->
                SELECT 
                    TO_CHAR(d, 'YYYY-MM') AS month,
                    (
                        SELECT COUNT(*)::int 
                        FROM complaint c 
                        LEFT JOIN complaint_agency ca ON c.complaint_no = ca.complaint_no
                        WHERE TO_CHAR(c.created_date, 'YYYY-MM') = TO_CHAR(d, 'YYYY-MM')
                        AND c.status != 'DELETED'
                        <if test="category != null and category != '전체' and category != ''">
                            AND c.category = #{category}
                        </if>
                        <if test="agencyNo != null">
                            AND ca.agency_no = #{agencyNo}
                        </if>
                    ) AS received,
                    (
                        SELECT COUNT(*)::int 
                        FROM complaint c 
                        LEFT JOIN complaint_agency ca ON c.complaint_no = ca.complaint_no
                        WHERE TO_CHAR(c.completed_date, 'YYYY-MM') = TO_CHAR(d, 'YYYY-MM')
                        AND c.status != 'DELETED'
                        <if test="category != null and category != '전체' and category != ''">
                            AND c.category = #{category}
                        </if>
                        <if test="agencyNo != null">
                            AND ca.agency_no = #{agencyNo}
                        </if>
                    ) AS completed,
                    COALESCE((
                        SELECT ROUND(
                            AVG(CASE WHEN (
                                SELECT count(*) 
                                FROM generate_series(c.created_date::date + 1, c.updated_date::date, '1 day') AS gs 
                                WHERE extract(dow from gs) NOT IN (0, 6)
                            ) &lt;= 3 THEN 100.0 ELSE 0.0 END), 1
                        )
                        FROM complaint c 
                        LEFT JOIN complaint_agency ca ON c.complaint_no = ca.complaint_no
                        WHERE c.status = 'COMPLETED' 
                        AND TO_CHAR(c.completed_date, 'YYYY-MM') = TO_CHAR(d, 'YYYY-MM')
                        <if test="category != null and category != '전체' and category != ''">
                            AND c.category = #{category}
                        </if>
                        <if test="agencyNo != null">
                            AND ca.agency_no = #{agencyNo}
                        </if>
                    ), 0) AS sla_rate
                FROM (
                    SELECT generate_series(
                        CURRENT_DATE - INTERVAL '5 months', 
                        CURRENT_DATE, 
                        '1 month'
                    )::date AS d
                ) d
                ORDER BY d ASC
            </otherwise>
        </choose>
    </select>

    <!-- 통계(기관별 병목): 자치구별 미처리 민원 현황 TOP 10 조회 (주소 기반) -->
    <select id="selectAgencyBottleneck" resultType="map">
        SELECT
            SPLIT_PART(address, ' ', 2) AS name,
            COUNT(CASE WHEN status IN ('RECEIVED', 'UNPROCESSED', 'IN_PROGRESS') THEN 1 END)::int AS count
        FROM complaint c
        LEFT JOIN complaint_agency ca ON c.complaint_no = ca.complaint_no
        WHERE c.address IS NOT NULL
        AND c.address LIKE '서울특별시%'
        <if test="agencyNo != null">
            AND ca.agency_no = #{agencyNo}
        </if>
        GROUP BY SPLIT_PART(c.address, ' ', 2)
        ORDER BY count DESC
        LIMIT 10
    </select>

    <!-- 통계(구별 지연): 3일 이상 처리 지연된 민원이 많은 자치구 TOP 10 조회 -->
    <select id="selectDistrictOverdue" resultType="map">
        SELECT
            SPLIT_PART(address, ' ', 2) AS name,
            COUNT(*)::int AS count
        FROM complaint c
        LEFT JOIN complaint_agency ca ON c.complaint_no = ca.complaint_no
        WHERE c.status IN ('RECEIVED', 'UNPROCESSED', 'IN_PROGRESS')
          AND (
                SELECT count(*) 
                FROM generate_series(c.created_date::date + 1, CURRENT_DATE, '1 day') AS d 
                WHERE extract(dow from d) NOT IN (0, 6)
            ) > 3
          AND c.address IS NOT NULL
          AND c.address LIKE '서울특별시%'
          <if test="agencyNo != null">
              AND ca.agency_no = #{agencyNo}
          </if>
        GROUP BY SPLIT_PART(c.address, ' ', 2)
        ORDER BY count DESC
        LIMIT 10
    </select>

    <!-- 통계(연령별): 민원인의 연령대별 민원 접수 분포 조회 (app_user 테이블 조인) -->
    <select id="selectAgeGroupStats" resultType="map">
        SELECT
            CASE
                WHEN EXTRACT(YEAR FROM age(CURRENT_DATE, u.birth_date)) BETWEEN 10 AND 19 THEN '10대'
                WHEN EXTRACT(YEAR FROM age(CURRENT_DATE, u.birth_date)) BETWEEN 20 AND 29 THEN '20대'
                WHEN EXTRACT(YEAR FROM age(CURRENT_DATE, u.birth_date)) BETWEEN 30 AND 39 THEN '30대'
                WHEN EXTRACT(YEAR FROM age(CURRENT_DATE, u.birth_date)) BETWEEN 40 AND 49 THEN '40대'
                WHEN EXTRACT(YEAR FROM age(CURRENT_DATE, u.birth_date)) BETWEEN 50 AND 59 THEN '50대'
                ELSE '60대+'
            END AS agegroup,
            COUNT(*)::int AS count
        FROM complaint c
        JOIN app_user u ON c.user_no = u.user_no
        LEFT JOIN complaint_agency ca ON c.complaint_no = ca.complaint_no
        WHERE u.birth_date IS NOT NULL
        <if test="agencyNo != null">
            AND ca.agency_no = #{agencyNo}
        </if>
        GROUP BY agegroup
        ORDER BY agegroup
    </select>

    <!-- 통계(지연 상세): 현재 3일 이상 지연된 민원들의 실시간 목록 조회 (상세 대시보드용) -->
    <select id="selectOverdueComplaintList" resultType="map">
        SELECT
            c.complaint_no AS id,
            c.category,
            c.title,
            SPLIT_PART(c.address, ' ', 2) AS district,
            COALESCE(
                (
                    SELECT STRING_AGG(a.agency_name, ', ')
                    FROM agency a
                    JOIN complaint_agency ca ON a.agency_no = ca.agency_no
                    WHERE ca.complaint_no = c.complaint_no
                ),
                '미배정'
            ) AS agency,
            CONCAT(
                (
                    SELECT count(*) 
                    FROM generate_series(c.created_date::date + 1, CURRENT_DATE, '1 day') AS d 
                    WHERE extract(dow from d) NOT IN (0, 6)
                ), '일 지연'
            ) AS overdueTime
        FROM complaint c
        LEFT JOIN complaint_agency ca ON c.complaint_no = ca.complaint_no
        WHERE c.status IN ('RECEIVED', 'UNPROCESSED', 'IN_PROGRESS')
          AND (
                SELECT count(*) 
                FROM generate_series(c.created_date::date + 1, CURRENT_DATE, '1 day') AS d 
                WHERE extract(dow from d) NOT IN (0, 6)
            ) > 3
          AND c.address LIKE '서울특별시%'
          <if test="agencyNo != null">
              AND ca.agency_no = #{agencyNo}
          </if>
        ORDER BY c.created_date ASC
        LIMIT 100
    </select>

</mapper>
